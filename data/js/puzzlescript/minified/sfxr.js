var SOUND_VOL=.25;var SAMPLE_RATE=5512;var BIT_DEPTH=8;var SQUARE=0;var SAWTOOTH=1;var SINE=2;var NOISE=3;var TRIANGLE=4;var BREAKER=5;var SHAPES=["square","sawtooth","sine","noise","triangle","breaker"];var AUDIO_CONTEXT;if(typeof AudioContext!="undefined"){AUDIO_CONTEXT=new AudioContext}else if(typeof webkitAudioContext!="undefined"){AUDIO_CONTEXT=new webkitAudioContext}var masterVolume=1;function Params(){var result={};result.wave_type=SQUARE;result.p_env_attack=0;result.p_env_sustain=.3;result.p_env_punch=0;result.p_env_decay=.4;result.p_base_freq=.3;result.p_freq_limit=0;result.p_freq_ramp=0;result.p_freq_dramp=0;result.p_vib_strength=0;result.p_vib_speed=0;result.p_arp_mod=0;result.p_arp_speed=0;result.p_duty=0;result.p_duty_ramp=0;result.p_repeat_speed=0;result.p_pha_offset=0;result.p_pha_ramp=0;result.p_lpf_freq=1;result.p_lpf_ramp=0;result.p_lpf_resonance=0;result.p_hpf_freq=0;result.p_hpf_ramp=0;result.sound_vol=.5;result.sample_rate=44100;result.bit_depth=8;return result}var rng;var seeded=false;function frnd(range){if(seeded){return rng.uniform()*range}else{return Math.random()*range}}function rnd(max){if(seeded){return Math.floor(rng.uniform()*(max+1))}else{return Math.floor(Math.random()*(max+1))}}pickupCoin=function(){var result=Params();result.wave_type=Math.floor(frnd(SHAPES.length));if(result.wave_type===3){result.wave_type=0}result.p_base_freq=.4+frnd(.5);result.p_env_attack=0;result.p_env_sustain=frnd(.1);result.p_env_decay=.1+frnd(.4);result.p_env_punch=.3+frnd(.3);if(rnd(1)){result.p_arp_speed=.5+frnd(.2);var num=(frnd(7)|1)+1;var den=num+(frnd(7)|1)+2;result.p_arp_mod=+num/+den}return result};laserShoot=function(){var result=Params();result.wave_type=rnd(2);if(result.wave_type===SINE&&rnd(1))result.wave_type=rnd(1);result.wave_type=Math.floor(frnd(SHAPES.length));if(result.wave_type===3){result.wave_type=SQUARE}result.p_base_freq=.5+frnd(.5);result.p_freq_limit=result.p_base_freq-.2-frnd(.6);if(result.p_freq_limit<.2)result.p_freq_limit=.2;result.p_freq_ramp=-.15-frnd(.2);if(rnd(2)===0){result.p_base_freq=.3+frnd(.6);result.p_freq_limit=frnd(.1);result.p_freq_ramp=-.35-frnd(.3)}if(rnd(1)){result.p_duty=frnd(.5);result.p_duty_ramp=frnd(.2)}else{result.p_duty=.4+frnd(.5);result.p_duty_ramp=-frnd(.7)}result.p_env_attack=0;result.p_env_sustain=.1+frnd(.2);result.p_env_decay=frnd(.4);if(rnd(1))result.p_env_punch=frnd(.3);if(rnd(2)===0){result.p_pha_offset=frnd(.2);result.p_pha_ramp=-frnd(.2)}if(rnd(1))result.p_hpf_freq=frnd(.3);return result};explosion=function(){var result=Params();if(rnd(1)){result.p_base_freq=.1+frnd(.4);result.p_freq_ramp=-.1+frnd(.4)}else{result.p_base_freq=.2+frnd(.7);result.p_freq_ramp=-.2-frnd(.2)}result.p_base_freq*=result.p_base_freq;if(rnd(4)===0)result.p_freq_ramp=0;if(rnd(2)===0)result.p_repeat_speed=.3+frnd(.5);result.p_env_attack=0;result.p_env_sustain=.1+frnd(.3);result.p_env_decay=frnd(.5);if(rnd(1)===0){result.p_pha_offset=-.3+frnd(.9);result.p_pha_ramp=-frnd(.3)}result.p_env_punch=.2+frnd(.6);if(rnd(1)){result.p_vib_strength=frnd(.7);result.p_vib_speed=frnd(.6)}if(rnd(2)===0){result.p_arp_speed=.6+frnd(.3);result.p_arp_mod=.8-frnd(1.6)}return result};birdSound=function(){var result=Params();if(frnd(10)<1){result.wave_type=Math.floor(frnd(SHAPES.length));if(result.wave_type===3){result.wave_type=SQUARE}result.p_env_attack=.4304400932967592+frnd(.2)-.1;result.p_env_sustain=.15739346034252394+frnd(.2)-.1;result.p_env_punch=.004488201744871758+frnd(.2)-.1;result.p_env_decay=.07478075528212291+frnd(.2)-.1;result.p_base_freq=.9865265720147687+frnd(.2)-.1;result.p_freq_limit=0+frnd(.2)-.1;result.p_freq_ramp=-.2995018224359539+frnd(.2)-.1;if(frnd(1)<.5){result.p_freq_ramp=.1+frnd(.15)}result.p_freq_dramp=.004598608156964473+frnd(.1)-.05;result.p_vib_strength=-.2202799497929496+frnd(.2)-.1;result.p_vib_speed=.8084998703158364+frnd(.2)-.1;result.p_arp_mod=0;result.p_arp_speed=0;result.p_duty=-.9031808754347107+frnd(.2)-.1;result.p_duty_ramp=-.8128699999808343+frnd(.2)-.1;result.p_repeat_speed=.601486018931999+frnd(.2)-.1;result.p_pha_offset=-.9424902314367765+frnd(.2)-.1;result.p_pha_ramp=-.1055482222272056+frnd(.2)-.1;result.p_lpf_freq=.9989765717851521+frnd(.2)-.1;result.p_lpf_ramp=-.25051720626043017+frnd(.2)-.1;result.p_lpf_resonance=.32777871505494693+frnd(.2)-.1;result.p_hpf_freq=.0023548750981756753+frnd(.2)-.1;result.p_hpf_ramp=-.002375673204842568+frnd(.2)-.1;return result}if(frnd(10)<1){result.wave_type=Math.floor(frnd(SHAPES.length));if(result.wave_type===3){result.wave_type=SQUARE}result.p_env_attack=.5277795946672003+frnd(.2)-.1;result.p_env_sustain=.18243733568468432+frnd(.2)-.1;result.p_env_punch=-.020159754546840117+frnd(.2)-.1;result.p_env_decay=.1561353422051903+frnd(.2)-.1;result.p_base_freq=.9028855606533718+frnd(.2)-.1;result.p_freq_limit=-.008842787837148716;result.p_freq_ramp=-.1;result.p_freq_dramp=-.012891241489551925;result.p_vib_strength=-.17923136138403065+frnd(.2)-.1;result.p_vib_speed=.908263385610142+frnd(.2)-.1;result.p_arp_mod=.41690153355414894+frnd(.2)-.1;result.p_arp_speed=.0010766233195860704+frnd(.2)-.1;result.p_duty=-.8735363011184684+frnd(.2)-.1;result.p_duty_ramp=-.7397985366747507+frnd(.2)-.1;result.p_repeat_speed=.0591789344172107+frnd(.2)-.1;result.p_pha_offset=-.9961184222777699+frnd(.2)-.1;result.p_pha_ramp=-.08234769395850523+frnd(.2)-.1;result.p_lpf_freq=.9412475115697335+frnd(.2)-.1;result.p_lpf_ramp=-.18261358925834958+frnd(.2)-.1;result.p_lpf_resonance=.24541438107389477+frnd(.2)-.1;result.p_hpf_freq=-.01831940280978611+frnd(.2)-.1;result.p_hpf_ramp=-.03857383633171346+frnd(.2)-.1;return result}if(frnd(10)<1){result.wave_type=Math.floor(frnd(SHAPES.length));if(result.wave_type===3){result.wave_type=SQUARE}result.p_env_attack=.4304400932967592+frnd(.2)-.1;result.p_env_sustain=.15739346034252394+frnd(.2)-.1;result.p_env_punch=.004488201744871758+frnd(.2)-.1;result.p_env_decay=.07478075528212291+frnd(.2)-.1;result.p_base_freq=.9865265720147687+frnd(.2)-.1;result.p_freq_limit=0+frnd(.2)-.1;result.p_freq_ramp=-.2995018224359539+frnd(.2)-.1;result.p_freq_dramp=.004598608156964473+frnd(.2)-.1;result.p_vib_strength=-.2202799497929496+frnd(.2)-.1;result.p_vib_speed=.8084998703158364+frnd(.2)-.1;result.p_arp_mod=-.46410459213693644+frnd(.2)-.1;result.p_arp_speed=-.10955361249587248+frnd(.2)-.1;result.p_duty=-.9031808754347107+frnd(.2)-.1;result.p_duty_ramp=-.8128699999808343+frnd(.2)-.1;result.p_repeat_speed=.7014860189319991+frnd(.2)-.1;result.p_pha_offset=-.9424902314367765+frnd(.2)-.1;result.p_pha_ramp=-.1055482222272056+frnd(.2)-.1;result.p_lpf_freq=.9989765717851521+frnd(.2)-.1;result.p_lpf_ramp=-.25051720626043017+frnd(.2)-.1;result.p_lpf_resonance=.32777871505494693+frnd(.2)-.1;result.p_hpf_freq=.0023548750981756753+frnd(.2)-.1;result.p_hpf_ramp=-.002375673204842568+frnd(.2)-.1;return result}if(frnd(5)>1){result.wave_type=Math.floor(frnd(SHAPES.length));if(result.wave_type===3){result.wave_type=SQUARE}if(rnd(1)){result.p_arp_mod=.2697849293151393+frnd(.2)-.1;result.p_arp_speed=-.3131172257760948+frnd(.2)-.1;result.p_base_freq=.8090588299313949+frnd(.2)-.1;result.p_duty=-.6210022920964955+frnd(.2)-.1;result.p_duty_ramp=-.00043441813553182567+frnd(.2)-.1;result.p_env_attack=.004321877246874195+frnd(.2)-.1;result.p_env_decay=.1+frnd(.2)-.1;result.p_env_punch=.061737781504416146+frnd(.2)-.1;result.p_env_sustain=.4987252564798832+frnd(.2)-.1;result.p_freq_dramp=.31700340314222614+frnd(.2)-.1;result.p_freq_limit=0+frnd(.2)-.1;result.p_freq_ramp=-.163380391341416+frnd(.2)-.1;result.p_hpf_freq=.4709005021145149+frnd(.2)-.1;result.p_hpf_ramp=.6924667290539194+frnd(.2)-.1;result.p_lpf_freq=.8351398631384511+frnd(.2)-.1;result.p_lpf_ramp=.36616557192873134+frnd(.2)-.1;result.p_lpf_resonance=-.08685777111664439+frnd(.2)-.1;result.p_pha_offset=-.036084571580025544+frnd(.2)-.1;result.p_pha_ramp=-.014806445085568108+frnd(.2)-.1;result.p_repeat_speed=-.8094368475518489+frnd(.2)-.1;result.p_vib_speed=.4496665457171294+frnd(.2)-.1;result.p_vib_strength=.23413762515532424+frnd(.2)-.1}else{result.p_arp_mod=-.35697118026766184+frnd(.2)-.1;result.p_arp_speed=.3581140690559588+frnd(.2)-.1;result.p_base_freq=1.3260897696157528+frnd(.2)-.1;result.p_duty=-.30984900436710694+frnd(.2)-.1;result.p_duty_ramp=-.0014374759133411626+frnd(.2)-.1;result.p_env_attack=.3160357835682254+frnd(.2)-.1;result.p_env_decay=.1+frnd(.2)-.1;result.p_env_punch=.24323114016870148+frnd(.2)-.1;result.p_env_sustain=.4+frnd(.2)-.1;result.p_freq_dramp=.2866475886237244+frnd(.2)-.1;result.p_freq_limit=0+frnd(.2)-.1;result.p_freq_ramp=-.10956352368742976+frnd(.2)-.1;result.p_hpf_freq=.20772718017889846+frnd(.2)-.1;result.p_hpf_ramp=.1564090637378835+frnd(.2)-.1;result.p_lpf_freq=.6021372770637031+frnd(.2)-.1;result.p_lpf_ramp=.24016227139979027+frnd(.2)-.1;result.p_lpf_resonance=-.08787383821160144+frnd(.2)-.1;result.p_pha_offset=-.381597686151701+frnd(.2)-.1;result.p_pha_ramp=-.0002481687661373495+frnd(.2)-.1;result.p_repeat_speed=.07812112809425686+frnd(.2)-.1;result.p_vib_speed=-.13648848579133943+frnd(.2)-.1;result.p_vib_strength=.0018874158972302657+frnd(.2)-.1}return result}result.wave_type=Math.floor(frnd(SHAPES.length));if(result.wave_type===1||result.wave_type===3){result.wave_type=2}result.p_base_freq=.85+frnd(.15);result.p_freq_ramp=.3+frnd(.15);result.p_env_attack=0+frnd(.09);result.p_env_sustain=.2+frnd(.3);result.p_env_decay=0+frnd(.1);result.p_duty=frnd(2)-1;result.p_duty_ramp=Math.pow(frnd(2)-1,3);result.p_repeat_speed=.5+frnd(.1);result.p_pha_offset=-.3+frnd(.9);result.p_pha_ramp=-frnd(.3);result.p_arp_speed=.4+frnd(.6);result.p_arp_mod=.8+frnd(.1);result.p_lpf_resonance=frnd(2)-1;result.p_lpf_freq=1-Math.pow(frnd(1),3);result.p_lpf_ramp=Math.pow(frnd(2)-1,3);if(result.p_lpf_freq<.1&&result.p_lpf_ramp<-.05)result.p_lpf_ramp=-result.p_lpf_ramp;result.p_hpf_freq=Math.pow(frnd(1),5);result.p_hpf_ramp=Math.pow(frnd(2)-1,5);return result};pushSound=function(){var result=Params();result.wave_type=Math.floor(frnd(SHAPES.length));if(result.wave_type===2){result.wave_type++}if(result.wave_type===0){result.wave_type=NOISE}result.p_base_freq=.1+frnd(.4);result.p_freq_ramp=.05+frnd(.2);result.p_env_attack=.01+frnd(.09);result.p_env_sustain=.01+frnd(.09);result.p_env_decay=.01+frnd(.09);result.p_repeat_speed=.3+frnd(.5);result.p_pha_offset=-.3+frnd(.9);result.p_pha_ramp=-frnd(.3);result.p_arp_speed=.6+frnd(.3);result.p_arp_mod=.8-frnd(1.6);return result};powerUp=function(){var result=Params();if(rnd(1))result.wave_type=SAWTOOTH;else result.p_duty=frnd(.6);result.wave_type=Math.floor(frnd(SHAPES.length));if(result.wave_type===3){result.wave_type=SQUARE}if(rnd(1)){result.p_base_freq=.2+frnd(.3);result.p_freq_ramp=.1+frnd(.4);result.p_repeat_speed=.4+frnd(.4)}else{result.p_base_freq=.2+frnd(.3);result.p_freq_ramp=.05+frnd(.2);if(rnd(1)){result.p_vib_strength=frnd(.7);result.p_vib_speed=frnd(.6)}}result.p_env_attack=0;result.p_env_sustain=frnd(.4);result.p_env_decay=.1+frnd(.4);return result};hitHurt=function(){result=Params();result.wave_type=rnd(2);if(result.wave_type===SINE)result.wave_type=NOISE;if(result.wave_type===SQUARE)result.p_duty=frnd(.6);result.wave_type=Math.floor(frnd(SHAPES.length));result.p_base_freq=.2+frnd(.6);result.p_freq_ramp=-.3-frnd(.4);result.p_env_attack=0;result.p_env_sustain=frnd(.1);result.p_env_decay=.1+frnd(.2);if(rnd(1))result.p_hpf_freq=frnd(.3);return result};jump=function(){result=Params();result.wave_type=SQUARE;result.wave_type=Math.floor(frnd(SHAPES.length));if(result.wave_type===3){result.wave_type=SQUARE}result.p_duty=frnd(.6);result.p_base_freq=.3+frnd(.3);result.p_freq_ramp=.1+frnd(.2);result.p_env_attack=0;result.p_env_sustain=.1+frnd(.3);result.p_env_decay=.1+frnd(.2);if(rnd(1))result.p_hpf_freq=frnd(.3);if(rnd(1))result.p_lpf_freq=1-frnd(.6);return result};blipSelect=function(){result=Params();result.wave_type=rnd(1);result.wave_type=Math.floor(frnd(SHAPES.length));if(result.wave_type===3){result.wave_type=rnd(1)}if(result.wave_type===SQUARE)result.p_duty=frnd(.6);result.p_base_freq=.2+frnd(.4);result.p_env_attack=0;result.p_env_sustain=.1+frnd(.1);result.p_env_decay=frnd(.2);result.p_hpf_freq=.1;return result};random=function(){result=Params();result.wave_type=Math.floor(frnd(SHAPES.length));result.p_base_freq=Math.pow(frnd(2)-1,2);if(rnd(1))result.p_base_freq=Math.pow(frnd(2)-1,3)+.5;result.p_freq_limit=0;result.p_freq_ramp=Math.pow(frnd(2)-1,5);if(result.p_base_freq>.7&&result.p_freq_ramp>.2)result.p_freq_ramp=-result.p_freq_ramp;if(result.p_base_freq<.2&&result.p_freq_ramp<-.05)result.p_freq_ramp=-result.p_freq_ramp;result.p_freq_dramp=Math.pow(frnd(2)-1,3);result.p_duty=frnd(2)-1;result.p_duty_ramp=Math.pow(frnd(2)-1,3);result.p_vib_strength=Math.pow(frnd(2)-1,3);result.p_vib_speed=frnd(2)-1;result.p_env_attack=Math.pow(frnd(2)-1,3);result.p_env_sustain=Math.pow(frnd(2)-1,2);result.p_env_decay=frnd(2)-1;result.p_env_punch=Math.pow(frnd(.8),2);if(result.p_env_attack+result.p_env_sustain+result.p_env_decay<.2){result.p_env_sustain+=.2+frnd(.3);result.p_env_decay+=.2+frnd(.3)}result.p_lpf_resonance=frnd(2)-1;result.p_lpf_freq=1-Math.pow(frnd(1),3);result.p_lpf_ramp=Math.pow(frnd(2)-1,3);if(result.p_lpf_freq<.1&&result.p_lpf_ramp<-.05)result.p_lpf_ramp=-result.p_lpf_ramp;result.p_hpf_freq=Math.pow(frnd(1),5);result.p_hpf_ramp=Math.pow(frnd(2)-1,5);result.p_pha_offset=Math.pow(frnd(2)-1,3);result.p_pha_ramp=Math.pow(frnd(2)-1,3);result.p_repeat_speed=frnd(2)-1;result.p_arp_speed=frnd(2)-1;result.p_arp_mod=frnd(2)-1;return result};var generators=[pickupCoin,laserShoot,explosion,powerUp,hitHurt,jump,blipSelect,pushSound,random,birdSound];var generatorNames=["pickupCoin","laserShoot","explosion","powerUp","hitHurt","jump","blipSelect","pushSound","random","birdSound"];generateFromSeed=function(seed){rng=new RNG(seed/100|0);var generatorindex=seed%100;var soundGenerator=generators[generatorindex%generators.length];seeded=true;var result=soundGenerator();result.seed=seed;seeded=false;return result};function SoundEffect(length,sample_rate){this._buffer=AUDIO_CONTEXT.createBuffer(1,length,sample_rate)}SoundEffect.prototype.getBuffer=function(){return this._buffer.getChannelData(0)};SoundEffect.prototype.play=function(){var source=AUDIO_CONTEXT.createBufferSource();var filter1=AUDIO_CONTEXT.createBiquadFilter();var filter2=AUDIO_CONTEXT.createBiquadFilter();var filter3=AUDIO_CONTEXT.createBiquadFilter();source.buffer=this._buffer;source.connect(filter1);filter1.frequency.value=1600;filter2.frequency.value=1600;filter3.frequency.value=1600;filter1.connect(filter2);filter2.connect(filter3);filter3.connect(AUDIO_CONTEXT.destination);var t=AUDIO_CONTEXT.currentTime;if(typeof source.start!="undefined"){source.start(t)}else{source.noteOn(t)}};SoundEffect.MIN_SAMPLE_RATE=22050;if(typeof AUDIO_CONTEXT=="undefined"){SoundEffect=function SoundEffect(length,sample_rate){this._sample_rate=sample_rate;this._buffer=new Array(length);this._audioElement=null};SoundEffect.prototype.getBuffer=function(){this._audioElement=null;return this._buffer};SoundEffect.prototype.play=function(){if(this._audioElement){this._audioElement.cloneNode(false).play()}else{for(var i=0;i<this._buffer.length;i++){this._buffer[i]=255&Math.floor(128*Math.max(0,Math.min(this._buffer[i]+1,2)))}var wav=MakeRiff(this._sample_rate,BIT_DEPTH,this._buffer);this._audioElement=new Audio;this._audioElement.src=wav.dataURI;this._audioElement.play()}};SoundEffect.MIN_SAMPLE_RATE=1}SoundEffect.generate=function(ps){function repeat(){rep_time=0;fperiod=100/(ps.p_base_freq*ps.p_base_freq+.001);period=Math.floor(fperiod);fmaxperiod=100/(ps.p_freq_limit*ps.p_freq_limit+.001);fslide=1-Math.pow(ps.p_freq_ramp,3)*.01;fdslide=-Math.pow(ps.p_freq_dramp,3)*1e-6;square_duty=.5-ps.p_duty*.5;square_slide=-ps.p_duty_ramp*5e-5;if(ps.p_arp_mod>=0)arp_mod=1-Math.pow(ps.p_arp_mod,2)*.9;else arp_mod=1+Math.pow(ps.p_arp_mod,2)*10;arp_time=0;arp_limit=Math.floor(Math.pow(1-ps.p_arp_speed,2)*2e4+32);if(ps.p_arp_speed==1)arp_limit=0}var rep_time;var fperiod,period,fmaxperiod;var fslide,fdslide;var square_duty,square_slide;var arp_mod,arp_time,arp_limit;repeat();var fltp=0;var fltdp=0;var fltw=Math.pow(ps.p_lpf_freq,3)*.1;var fltw_d=1+ps.p_lpf_ramp*1e-4;var fltdmp=5/(1+Math.pow(ps.p_lpf_resonance,2)*20)*(.01+fltw);if(fltdmp>.8)fltdmp=.8;var fltphp=0;var flthp=Math.pow(ps.p_hpf_freq,2)*.1;var flthp_d=1+ps.p_hpf_ramp*3e-4;var vib_phase=0;var vib_speed=Math.pow(ps.p_vib_speed,2)*.01;var vib_amp=ps.p_vib_strength*.5;var env_vol=0;var env_stage=0;var env_time=0;var env_length=[Math.floor(ps.p_env_attack*ps.p_env_attack*1e5),Math.floor(ps.p_env_sustain*ps.p_env_sustain*1e5),Math.floor(ps.p_env_decay*ps.p_env_decay*1e5)];var env_total_length=env_length[0]+env_length[1]+env_length[2];var phase=0;var fphase=Math.pow(ps.p_pha_offset,2)*1020;if(ps.p_pha_offset<0)fphase=-fphase;var fdphase=Math.pow(ps.p_pha_ramp,2)*1;if(ps.p_pha_ramp<0)fdphase=-fdphase;var iphase=Math.abs(Math.floor(fphase));var ipp=0;var phaser_buffer=[];for(var i=0;i<1024;++i)phaser_buffer[i]=0;var noise_buffer=[];for(var i=0;i<32;++i)noise_buffer[i]=Math.random()*2-1;var rep_limit=Math.floor(Math.pow(1-ps.p_repeat_speed,2)*2e4+32);if(ps.p_repeat_speed==0)rep_limit=0;var gain=2*ps.sound_vol;var gain=Math.exp(ps.sound_vol)-1;var num_clipped=0;var sample_sum=0;var num_summed=0;var summands=Math.floor(44100/ps.sample_rate);var buffer_i=0;var buffer_length=Math.ceil(env_total_length/summands);var buffer_complete=false;var sound;if(ps.sample_rate<SoundEffect.MIN_SAMPLE_RATE){sound=new SoundEffect(4*buffer_length,SoundEffect.MIN_SAMPLE_RATE)}else{sound=new SoundEffect(buffer_length,ps.sample_rate)}var buffer=sound.getBuffer();for(var t=0;;++t){if(rep_limit!=0&&++rep_time>=rep_limit)repeat();if(arp_limit!=0&&t>=arp_limit){arp_limit=0;fperiod*=arp_mod}fslide+=fdslide;fperiod*=fslide;if(fperiod>fmaxperiod){fperiod=fmaxperiod;if(ps.p_freq_limit>0)buffer_complete=true}var rfperiod=fperiod;if(vib_amp>0){vib_phase+=vib_speed;rfperiod=fperiod*(1+Math.sin(vib_phase)*vib_amp)}period=Math.floor(rfperiod);if(period<8)period=8;square_duty+=square_slide;if(square_duty<0)square_duty=0;if(square_duty>.5)square_duty=.5;env_time++;if(env_time>env_length[env_stage]){env_time=0;env_stage++;if(env_stage===3)buffer_complete=true}if(env_stage===0)env_vol=env_time/env_length[0];else if(env_stage===1)env_vol=1+Math.pow(1-env_time/env_length[1],1)*2*ps.p_env_punch;else env_vol=1-env_time/env_length[2];fphase+=fdphase;iphase=Math.abs(Math.floor(fphase));if(iphase>1023)iphase=1023;if(flthp_d!=0){flthp*=flthp_d;if(flthp<1e-5)flthp=1e-5;if(flthp>.1)flthp=.1}var sample=0;for(var si=0;si<8;++si){var sub_sample=0;phase++;if(phase>=period){phase%=period;if(ps.wave_type===NOISE)for(var i=0;i<32;++i)noise_buffer[i]=Math.random()*2-1}var fp=phase/period;if(ps.wave_type===SQUARE){if(fp<square_duty)sub_sample=.5;else sub_sample=-.5}else if(ps.wave_type===SAWTOOTH){sub_sample=1-fp*2}else if(ps.wave_type===SINE){sub_sample=Math.sin(fp*2*Math.PI)}else if(ps.wave_type===NOISE){sub_sample=noise_buffer[Math.floor(phase*32/period)]}else if(ps.wave_type===TRIANGLE){sub_sample=Math.abs(1-fp*2)-1}else if(ps.wave_type===BREAKER){sub_sample=Math.abs(1-fp*fp*2)-1}else{throw new Exception("bad wave type! "+ps.wave_type)}var pp=fltp;fltw*=fltw_d;if(fltw<0)fltw=0;if(fltw>.1)fltw=.1;if(ps.p_lpf_freq!=1){fltdp+=(sub_sample-fltp)*fltw;fltdp-=fltdp*fltdmp}else{fltp=sub_sample;fltdp=0}fltp+=fltdp;fltphp+=fltp-pp;fltphp-=fltphp*flthp;sub_sample=fltphp;phaser_buffer[ipp&1023]=sub_sample;sub_sample+=phaser_buffer[ipp-iphase+1024&1023];ipp=ipp+1&1023;sample+=sub_sample*env_vol}sample_sum+=sample;if(++num_summed>=summands){num_summed=0;sample=sample_sum/summands;sample_sum=0}else{continue}sample=sample/8*masterVolume;sample*=gain;buffer[buffer_i++]=sample;if(ps.sample_rate<SoundEffect.MIN_SAMPLE_RATE){buffer[buffer_i++]=sample;buffer[buffer_i++]=sample;buffer[buffer_i++]=sample}if(buffer_complete){for(;buffer_i<buffer_length;buffer_i++){if(ps.sample_rate<SoundEffect.MIN_SAMPLE_RATE){buffer[buffer_i++]=0;buffer[buffer_i++]=0;buffer[buffer_i++]=0}buffer[buffer_i]=0}break}}return sound};if(typeof exports!="undefined"){var RIFFWAVE=require("./riffwave").RIFFWAVE;exports.Params=Params;exports.generate=generate}var sfxCache={};var cachedSeeds=[];var CACHE_MAX=50;function cacheSeed(seed){if(seed in sfxCache){return sfxCache[seed]}var params=generateFromSeed(seed);params.sound_vol=SOUND_VOL;params.sample_rate=SAMPLE_RATE;params.bit_depth=BIT_DEPTH;var sound=SoundEffect.generate(params);sfxCache[seed]=sound;cachedSeeds.push(seed);while(cachedSeeds.length>CACHE_MAX){var toRemove=cachedSeeds[0];cachedSeeds=cachedSeeds.slice(1);delete sfxCache[toRemove]}return sound}function playSound(seed){if(unitTesting)return;var sound=cacheSeed(seed);sound.play()}